// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import {EspressoNitroTEEVerifier} from "../src/EspressoNitroTEEVerifier.sol";
import {IEspressoNitroTEEVerifier} from "../src/interface/IEspressoNitroTEEVerifier.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import {CertManager} from "@nitro-validator/CertManager.sol";

contract EspressoSGXTEEVerifierTest is Test {
    address proxyAdmin = address(140);
    address adminTEE = address(141);
    address fakeAddress = address(145);

    EspressoNitroTEEVerifier espressoNitroTEEVerifier;
    bytes32 pcr0Hash = bytes32(0xc980e59163ce244bb4bb6211f48c7b46f88a4f40943e84eb99bdc41e129bd293);

    function setUp() public {
        vm.createSelectFork(
            "https://rpc.ankr.com/eth_sepolia/10a56026b3c20655c1dab931446156dea4d63d87d1261934c82a1b8045885923"
        );
        vm.startPrank(adminTEE);
        espressoNitroTEEVerifier = new EspressoNitroTEEVerifier(pcr0Hash, new CertManager());
        vm.stopPrank();
    }

    function testRegisterSigner() public {
        vm.startPrank(adminTEE);
        bytes memory attestation =
            hex"846a5369676e61747572653144a101382240591152a9696d6f64756c655f69647827692d30663933623863306539366530393431382d656e633031393564393164623137623765376366646967657374665348413338346974696d657374616d701b00000195d91e30276470637273b000583000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001583000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002583000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003583000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004583019f94ac40d4a5204d91ea2f41a235b64f761cf0d017941eea3484520737d11cafacf0ffd3b0429cc9913d9063b6066430558300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000658300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000758300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000858300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000958300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b636572746966696361746559027f3082027b30820201a00302010202100195d91db17b7e7c0000000067e5a967300a06082a8648ce3d04030330818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30663933623863306539366530393431382e75732d656173742d322e6177732e6e6974726f2d656e636c61766573301e170d3235303332373139333931365a170d3235303332373232333931395a308193310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313e303c06035504030c35692d30663933623863306539366530393431382d656e63303139356439316462313762376537632e75732d656173742d322e6177733076301006072a8648ce3d020106052b81040022036200042a92ac36cc0e9cbe9a793b7f97f2470360bc1d75a29237b3302e9d27c16ca72f182296b8663c2a6b415d709199037640a107b7cce279189f88f0528fabe6f81ea8d57ac4dc3fd5d694832f01151e5fd4ec73e7123a65d6a3443009d1057fe48aa31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d040303036800306502307a5b396f98ef25cfe0df9371c78ee376e4bad78cabcb90bbc80840a38a41db5542bf07c4f3a161853f04a525444d452f0231009ae1de2e4dca6a617e192c517fb5ecf14d065ead53a3c343910194ef75c064b91785c0ef9c14e3a58eff055113e3419968636162756e646c65845902153082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff65902c3308202bf30820245a0030201020211008460b202da76c3766c90087c98f88d57300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3235303332373034343830385a170d3235303431363035343830385a3064310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533136303406035504030c2d646666353333326635353364363330642e75732d656173742d322e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004089a383838bcaedb43acfc7640daa60ae4e1661607f2e601d26b54503798d4038ccc7e9941a116f352675ef1dde4c33f533a7359eb76d741f7115d5a0211b2f8781f427f32edf7ca2d3631dfafe2baed02ddba2f76a27816c70c2c9ee19a1fefa381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e0416041404fe42f289e6fba660fb8a20d596ebdd7242e950300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d040303036800306502301423c2f264257e23e4197dc7eb2e365934a82e0fd16a580b6b7251a0a70437acfc40e74b8c99e108a7598837123b5e89023100a4297d7c08de9dd692482e076f5e6ebf4f42810503a17a2b6fa9835f9e61a2836c80510ff9b676cb999d4ef7b04ea8a4590319308203153082029ba003020102021100d239a68ebc5e7aec3619ee065ba8a95a300a06082a8648ce3d0403033064310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533136303406035504030c2d646666353333326635353364363330642e75732d656173742d322e6177732e6e6974726f2d656e636c61766573301e170d3235303332373035323432365a170d3235303430313231323432365a308189313c303a06035504030c33613939653961353037366661376534372e7a6f6e616c2e75732d656173742d322e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b81040022036200044aed53b9c6c843511e1bde7bc225e191b8f29e1b1857ace53179c31ef9d7f6f107987a296f74b743c4ae4c09d5eb79084ed307c253b750392260c5188e62e8da1373a9187015fb9ec5eec114aaf74ea83ea928e8fc4cc5cfcc82022b61848a58a381ea3081e730120603551d130101ff040830060101ff020101301f0603551d2304183016801404fe42f289e6fba660fb8a20d596ebdd7242e950301d0603551d0e04160414dc630745fe1a159abc78b85ea4bd5af64374ee82300e0603551d0f0101ff0404030201863081800603551d1f047930773075a073a071866f687474703a2f2f63726c2d75732d656173742d322d6177732d6e6974726f2d656e636c617665732e73332e75732d656173742d322e616d617a6f6e6177732e636f6d2f63726c2f64363362343535662d396539362d343930362d616330362d6661346239643638346233662e63726c300a06082a8648ce3d0403030368003065023025b1b07aacf4db2a2718bfc5654c8066d55144deb3367954127fddfab9d703fd1eff8b88ac0e9419f7247b51d96a35dd023100adf9fa0ecf84707af4e4aecf6a03856146865b6de1a9a20c91ac53b588550ef1d220dc6787e624f6c49f1b118e900a225902c3308202bf30820245a00302010202150098def0b2e524576dd6417ef9d9f2e8e32b19546b300a06082a8648ce3d040303308189313c303a06035504030c33613939653961353037366661376534372e7a6f6e616c2e75732d656173742d322e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3235303332373135313131345a170d3235303332383135313131345a30818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30663933623863306539366530393431382e75732d656173742d322e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b81040022036200045af5a39b024e0ff610313efdea680ee7ae2ffe873e3fe64af51b903ad02e8bd43168edb16831e801694e360f0d3040725e009dbd56c86858d35afb8c2b635a20d1db9c8efcd60bdae6a22a2cdc630d9ff9eda4a7d9dbc1fb98c4c8226b1b0e61a366306430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204301d0603551d0e04160414c7e98e12b488d4a777e3fc9f1f56804816c9b333301f0603551d23041830168014dc630745fe1a159abc78b85ea4bd5af64374ee82300a06082a8648ce3d0403030368003065023100b467a0cf485fb3f268dc26ca285f1a6c21d20c0a0120e04e50d9c7af6f2ca5d90cddbb277b7063c11dc179f1ca0415980230316a05a6f33c738b66e37f27458cc7fcbd8ebacd72c13d7d64ae437143a8c0fe9d469cefaca228d9fab186f68d5a2f8a6a7075626c69635f6b6579584104090e39a638094d9805b89a831b7e710db345e701bb0e9865a60b6b50089b3f4b89c168fbf2219ba79b6e86eb63decac3be0dd3e8fb4c0f1b39d4ecd4589704ff69757365725f646174614f6d792d656e636c6176652d64617461656e6f6e6365f6";
        bytes memory signature =
            hex"91269dcaa454f6c27a35686e4e48aef48f2aa210c36d6a7efc9e30dae67963d7ee8abb9a59ba1e306b793adfe4da4c1c4a9777023b941d0f30b2122f42b37506527eeff97e0e762da4e16a954af7b187cb8f11d6e050447e4b51cfa8885fc0c0";

        espressoNitroTEEVerifier.registerSigner(attestation, signature);
        vm.stopPrank();
    }

    function testInvalidSignature() public {
        vm.startPrank(adminTEE);
        bytes memory attestation =
            hex"846a5369676e61747572653144a101382240591152a9696d6f64756c655f69647827692d30663933623863306539366530393431382d656e633031393564393164623137623765376366646967657374665348413338346974696d657374616d701b00000195d91e30276470637273b000583000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001583000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002583000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003583000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004583019f94ac40d4a5204d91ea2f41a235b64f761cf0d017941eea3484520737d11cafacf0ffd3b0429cc9913d9063b6066430558300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000658300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000758300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000858300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000958300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b636572746966696361746559027f3082027b30820201a00302010202100195d91db17b7e7c0000000067e5a967300a06082a8648ce3d04030330818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30663933623863306539366530393431382e75732d656173742d322e6177732e6e6974726f2d656e636c61766573301e170d3235303332373139333931365a170d3235303332373232333931395a308193310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313e303c06035504030c35692d30663933623863306539366530393431382d656e63303139356439316462313762376537632e75732d656173742d322e6177733076301006072a8648ce3d020106052b81040022036200042a92ac36cc0e9cbe9a793b7f97f2470360bc1d75a29237b3302e9d27c16ca72f182296b8663c2a6b415d709199037640a107b7cce279189f88f0528fabe6f81ea8d57ac4dc3fd5d694832f01151e5fd4ec73e7123a65d6a3443009d1057fe48aa31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d040303036800306502307a5b396f98ef25cfe0df9371c78ee376e4bad78cabcb90bbc80840a38a41db5542bf07c4f3a161853f04a525444d452f0231009ae1de2e4dca6a617e192c517fb5ecf14d065ead53a3c343910194ef75c064b91785c0ef9c14e3a58eff055113e3419968636162756e646c65845902153082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff65902c3308202bf30820245a0030201020211008460b202da76c3766c90087c98f88d57300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3235303332373034343830385a170d3235303431363035343830385a3064310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533136303406035504030c2d646666353333326635353364363330642e75732d656173742d322e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004089a383838bcaedb43acfc7640daa60ae4e1661607f2e601d26b54503798d4038ccc7e9941a116f352675ef1dde4c33f533a7359eb76d741f7115d5a0211b2f8781f427f32edf7ca2d3631dfafe2baed02ddba2f76a27816c70c2c9ee19a1fefa381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e0416041404fe42f289e6fba660fb8a20d596ebdd7242e950300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d040303036800306502301423c2f264257e23e4197dc7eb2e365934a82e0fd16a580b6b7251a0a70437acfc40e74b8c99e108a7598837123b5e89023100a4297d7c08de9dd692482e076f5e6ebf4f42810503a17a2b6fa9835f9e61a2836c80510ff9b676cb999d4ef7b04ea8a4590319308203153082029ba003020102021100d239a68ebc5e7aec3619ee065ba8a95a300a06082a8648ce3d0403033064310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533136303406035504030c2d646666353333326635353364363330642e75732d656173742d322e6177732e6e6974726f2d656e636c61766573301e170d3235303332373035323432365a170d3235303430313231323432365a308189313c303a06035504030c33613939653961353037366661376534372e7a6f6e616c2e75732d656173742d322e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b81040022036200044aed53b9c6c843511e1bde7bc225e191b8f29e1b1857ace53179c31ef9d7f6f107987a296f74b743c4ae4c09d5eb79084ed307c253b750392260c5188e62e8da1373a9187015fb9ec5eec114aaf74ea83ea928e8fc4cc5cfcc82022b61848a58a381ea3081e730120603551d130101ff040830060101ff020101301f0603551d2304183016801404fe42f289e6fba660fb8a20d596ebdd7242e950301d0603551d0e04160414dc630745fe1a159abc78b85ea4bd5af64374ee82300e0603551d0f0101ff0404030201863081800603551d1f047930773075a073a071866f687474703a2f2f63726c2d75732d656173742d322d6177732d6e6974726f2d656e636c617665732e73332e75732d656173742d322e616d617a6f6e6177732e636f6d2f63726c2f64363362343535662d396539362d343930362d616330362d6661346239643638346233662e63726c300a06082a8648ce3d0403030368003065023025b1b07aacf4db2a2718bfc5654c8066d55144deb3367954127fddfab9d703fd1eff8b88ac0e9419f7247b51d96a35dd023100adf9fa0ecf84707af4e4aecf6a03856146865b6de1a9a20c91ac53b588550ef1d220dc6787e624f6c49f1b118e900a225902c3308202bf30820245a00302010202150098def0b2e524576dd6417ef9d9f2e8e32b19546b300a06082a8648ce3d040303308189313c303a06035504030c33613939653961353037366661376534372e7a6f6e616c2e75732d656173742d322e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3235303332373135313131345a170d3235303332383135313131345a30818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30663933623863306539366530393431382e75732d656173742d322e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b81040022036200045af5a39b024e0ff610313efdea680ee7ae2ffe873e3fe64af51b903ad02e8bd43168edb16831e801694e360f0d3040725e009dbd56c86858d35afb8c2b635a20d1db9c8efcd60bdae6a22a2cdc630d9ff9eda4a7d9dbc1fb98c4c8226b1b0e61a366306430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204301d0603551d0e04160414c7e98e12b488d4a777e3fc9f1f56804816c9b333301f0603551d23041830168014dc630745fe1a159abc78b85ea4bd5af64374ee82300a06082a8648ce3d0403030368003065023100b467a0cf485fb3f268dc26ca285f1a6c21d20c0a0120e04e50d9c7af6f2ca5d90cddbb277b7063c11dc179f1ca0415980230316a05a6f33c738b66e37f27458cc7fcbd8ebacd72c13d7d64ae437143a8c0fe9d469cefaca228d9fab186f68d5a2f8a6a7075626c69635f6b6579584104090e39a638094d9805b89a831b7e710db345e701bb0e9865a60b6b50089b3f4b89c168fbf2219ba79b6e86eb63decac3be0dd3e8fb4c0f1b39d4ecd4589704ff69757365725f646174614f6d792d656e636c6176652d64617461656e6f6e6365f6";
        bytes memory signature =
            hex"01269dcaa454f6c27a35686e4e48aef48f2aa210c36d6a7efc9e30dae67963d7ee8abb9a59ba1e306b793adfe4da4c1c4a9777023b941d0f30b2122f42b37506527eeff97e0e762da4e16a954af7b187cb8f11d6e050447e4b51cfa8885fc0c0";

        // Incorrect signature
        vm.expectRevert(bytes("invalid sig"));
        espressoNitroTEEVerifier.registerSigner(attestation, signature);
        vm.stopPrank();
    }
}
